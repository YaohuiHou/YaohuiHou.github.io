(window.webpackJsonp=window.webpackJsonp||[]).push([[278],{507:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"content"},[a("h2",{attrs:{id:"写在前面"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#写在前面","aria-hidden":"true"}},[s._v("#")]),s._v(" 写在前面")]),a("p",[s._v("本文先简单介绍session跟cookie的区别与联系，接着深入剖析"),a("code",[s._v("express-session")]),s._v("中间件的实现。关于"),a("code",[s._v("express-session")]),s._v("的基础使用，可参见笔者前面的文章。")]),a("h2",{attrs:{id:"session-vs-cookie-vs-登录态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#session-vs-cookie-vs-登录态","aria-hidden":"true"}},[s._v("#")]),s._v(" session vs cookie vs 登录态")]),a("p",[s._v("HTTP是无状态的，也就是说，同个用户，多次访问同一个网站，网站无法区分前后访问的是否同个用户。cookie跟session的出现很好的解决了这个问题。")]),a("p",[s._v("抛开两者的学术定义，从应用的角度来讲，session跟cookie就是一对好基友，可以用来实现用户的身份识别。")]),a("p",[s._v("session是保存在服务端的小段数据，cookie是保存在用户本地的小段数据，它们一般是一一对应的。")]),a("p",[s._v("上面的解释比较抽象，先举两个常见的例子："),a("strong",[s._v("用户登录")]),s._v(" 和 "),a("strong",[s._v("登录态检验")]),s._v("。")]),a("h3",{attrs:{id:"用户登录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户登录","aria-hidden":"true"}},[s._v("#")]),s._v(" 用户登录")]),a("ol",[a("li",[s._v("张三：在网站输入用户名(zhang)、密码，点击“登录”。")]),a("li",[s._v("浏览器：向服务端发送登录请求。")]),a("li",[s._v("服务端：收到登录请求，对 用户名、密码 进行校验，且校验通过。")]),a("li",[s._v("服务端：把张三的用户名 zhang 写到本地文件 session.txt。（session）")]),a("li",[s._v("服务端：请求成功返回，附带 "),a("code",[s._v("Set-Cookie:uid=zhang")]),s._v(" 首部。")]),a("li",[s._v("浏览器：收到服务端返回，检测到 "),a("code",[s._v("Set-Cookie")]),s._v(" 首部，将cookie("),a("code",[s._v("uid=zhang")]),s._v(")保存到本地。(cookie)")])]),a("h3",{attrs:{id:"登录态检验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#登录态检验","aria-hidden":"true"}},[s._v("#")]),s._v(" 登录态检验")]),a("p",[s._v("张三再次访问网站：")]),a("ol",[a("li",[s._v("张三：访问网站的个人主页。")]),a("li",[s._v("浏览器：向服务端发送访问请求（带上之前的cookie）。")]),a("li",[s._v("服务端：解析cookie，找到"),a("code",[s._v("uid=zhang")]),s._v("。")]),a("li",[s._v("服务端：查找本地session.txt，发现"),a("code",[s._v("uid=zhang")]),s._v("这条记录，判断用户已登录。")]),a("li",[s._v("服务端：返回个人主页。")])]),a("h2",{attrs:{id:"express-session实现原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#express-session实现原理","aria-hidden":"true"}},[s._v("#")]),s._v(" express-session实现原理")]),a("p",[s._v("关键配置如下。其中，"),a("code",[s._v("saveUninitialized")]),s._v("若为"),a("code",[s._v("true")]),s._v("，对状态为“未初始化”的会话，服务端会自动为该会话创建session id，并保存到本地。")]),a("p",[s._v("对于需要实现登录功能的站点，需要将"),a("code",[s._v("saveUninitialized")]),s._v("设置为"),a("code",[s._v("false")]),s._v("。")]),a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("app"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("use")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token function"}},[s._v("session")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    name"),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" identityKey"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    secret"),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'chyingp'")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),a("span",{attrs:{class:"token comment"}},[s._v("// 用来对session id相关的cookie进行签名")]),s._v("\n    store"),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{attrs:{class:"token class-name"}},[s._v("FileStore")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),a("span",{attrs:{class:"token comment"}},[s._v("// 本地存储session（文本文件，也可以选择其他store，比如redis的）")]),s._v("\n    saveUninitialized"),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{attrs:{class:"token boolean"}},[s._v("false")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),a("span",{attrs:{class:"token comment"}},[s._v("// 是否自动保存未初始化的会话，建议false")]),s._v("\n    resave"),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{attrs:{class:"token boolean"}},[s._v("false")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),a("span",{attrs:{class:"token comment"}},[s._v("// 是否每次都重新保存会话，建议false")]),s._v("\n    cookie"),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        maxAge"),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("1000")]),s._v("  "),a("span",{attrs:{class:"token comment"}},[s._v("// 有效期，单位是毫秒")]),s._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),a("p",[s._v("从请求的生命周期来看下express-session是怎么发挥作用的。")]),a("p",[s._v("首先，是一个“未初始化”的请求（比如第一次访问网站的用户）")]),a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("app"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("use")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token function"}},[s._v("session")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token comment"}},[s._v("/* 配置项 */")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\napp"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("use")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v("'/'")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("function")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("req"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" next"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("end")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v("'ok'")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),a("h2",{attrs:{id:"跟cookie-parser的关联"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跟cookie-parser的关联","aria-hidden":"true"}},[s._v("#")]),s._v(" 跟cookie-parser的关联")]),a("h2",{attrs:{id:"关注点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关注点","aria-hidden":"true"}},[s._v("#")]),s._v(" 关注点")]),a("ol",[a("li",[s._v("防止cookie篡改")]),a("li",[s._v("登录态超时机制")]),a("li",[s._v("登录态主动失效机制")])])])}],!1,null,null,null);t.default=e.exports}}]);